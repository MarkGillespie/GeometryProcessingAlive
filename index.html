<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Geometry Processing Alive!</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />
    <link rel="stylesheet" href="main.css" />
    <link rel="stylesheet" href="js/geoptic.js/src/style.css" />
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400&display=swap"
      rel="stylesheet"
    />

    <!-- add mocha css, to show results -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/mocha/3.2.0/mocha.css"
    />
    <!-- add mocha framework code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mocha/3.2.0/mocha.js"></script>
    <!-- add chai -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chai/3.5.0/chai.js"></script>
  </head>

  <body>
    <div class="header">
      <h2 id="title">Geometry Processing Alive!</h2>
      <div id="logos">
        <a
          href="https://geometrycollective.github.io/geometry-processing-js/"
          target="_blank"
        >
          <img
            src="js/geometry-processing-js/imgs/logo.svg"
            width="80"
            height="80"
            border="0"
          />
        </a>
      </div>
    </div>
    <div class="button-bar">
      <button id="run-button">Run Code</button>
      <button id="run-tests-button">Run Tests</button>
      <button id="save-button">Save</button>
      <button id="load-button">Load</button>
      <button id="download-button">Download</button>

      <span id="saving-notification" style="opacity: 0">Saving...</span>

      <!-- Hidden file input for loading files -->
      <input
        type="file"
        id="fileInput"
        style="visibility: hidden; position: absolute; left: 0; top: 0"
      />
    </div>

    <div class="resizeable">
      <!-- Use the monokai background color by default - prevents white background jumping jarringly to dark gray -->
      <pre id="editor" style="background-color: #272822">
/*
 * This function will be run on every vertex
 * and plotted to the right.
 */
function vertexFunction(geo, vertex) {
    return geo.positions[vertex].x;
}</pre
      >
      <div id="resizer"></div>
      <div id="content-panel">
        <button id="show-test-button">View Tests</button>
        <button id="show-scene-button">View Scene</button>
        <div id="geoptic-panel">
            <div class="lds-roller" id="spinner">
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
            </div>
        </div>
        <div id="test-panel"  style="display:none;">
          <div id="mocha"></div>
        </div>
      </div>
    </div>

    <details id="error-msgs" class="details-animated">
      <summary id="error-summary">No errors</summary>
      <div id="error-details"></div>
    </details>

    <div class="settings-bar">
      <div>
        <label for="enable-autocomplete">Autocomplete</label>
        <input
          type="checkbox"
          id="enable-autocomplete"
          value="enable-autocomplete"
        />
      </div>

      <div>
        <label for="keybindings-select">Keybindings:</label>
        <select name="keybindings" id="keybindings-select">
          <option value="ace/keyboard/sublime">Sublime</option>
          <option value="ace/keyboard/vscode">VSCode</option>
          <option value="">Ace</option>
          <option value="ace/keyboard/vim">Vim</option>
          <option value="ace/keyboard/emacs">Emacs</option>
        </select>
      </div>

      <div>
        <label for="color-scheme-select">Color scheme:</label>
        <select name="color-schemes" id="color-scheme-select">
          <optgroup label="Bright">
            <option value="ace/theme/chrome">Chrome</option>
            <option value="ace/theme/clouds">Clouds</option>
            <option value="ace/theme/crimson_editor">Crimson Editor</option>
            <option value="ace/theme/dawn">Dawn</option>
            <option value="ace/theme/dreamweaver">Dreamweaver</option>
            <option value="ace/theme/eclipse">Eclipse</option>
            <option value="ace/theme/github">GitHub</option>
            <option value="ace/theme/iplastic">IPlastic</option>
            <option value="ace/theme/solarized_light">Solarized Light</option>
            <option value="ace/theme/textmate">TextMate</option>
            <option value="ace/theme/tomorrow">Tomorrow</option>
            <option value="ace/theme/xcode">Xcode</option>
            <option value="ace/theme/kuroir">Kuroir</option>
            <option value="ace/theme/katzenmilch">KatzenMilch</option>
            <option value="ace/theme/sqlserver">SQL Server</option>
          </optgroup>
          <optgroup label="Dark">
            <option value="ace/theme/ambiance">Ambiance</option>
            <option value="ace/theme/chaos">Chaos</option>
            <option value="ace/theme/clouds_midnight">Clouds Midnight</option>
            <option value="ace/theme/dracula">Dracula</option>
            <option value="ace/theme/cobalt">Cobalt</option>
            <option value="ace/theme/gruvbox">Gruvbox</option>
            <option value="ace/theme/gob">Green on Black</option>
            <option value="ace/theme/idle_fingers">idle Fingers</option>
            <option value="ace/theme/kr_theme">krTheme</option>
            <option value="ace/theme/merbivore">Merbivore</option>
            <option value="ace/theme/merbivore_soft">Merbivore Soft</option>
            <option value="ace/theme/mono_industrial">Mono Industrial</option>
            <option value="ace/theme/monokai" selected>Monokai</option>
            <option value="ace/theme/nord_dark">Nord Dark</option>
            <option value="ace/theme/pastel_on_dark">Pastel on dark</option>
            <option value="ace/theme/solarized_dark">Solarized Dark</option>
            <option value="ace/theme/terminal">Terminal</option>
            <option value="ace/theme/tomorrow_night">Tomorrow Night</option>
            <option value="ace/theme/tomorrow_night_blue">
              Tomorrow Night Blue
            </option>
            <option value="ace/theme/tomorrow_night_bright">
              Tomorrow Night Bright
            </option>
            <option value="ace/theme/tomorrow_night_eighties">
              Tomorrow Night 80s
            </option>
            <option value="ace/theme/twilight">Twilight</option>
            <option value="ace/theme/vibrant_ink">Vibrant Ink</option>
          </optgroup>
        </select>
      </div>
    </div>

    <script src="https://pagecdn.io/lib/ace/1.4.12/ace.js"></script>
    <!-- Preload monokai (default color scheme) and mode-javascript -->
    <script src="https://pagecdn.io/lib/ace/1.4.12/theme-monokai.js"></script>
    <script src="https://pagecdn.io/lib/ace/1.4.12/mode-javascript.js"></script>
    <script src="https://pagecdn.io/lib/ace/1.4.12/snippets/javascript.js"></script>

    <!-- load ace language tools -->
    <script src="https://pagecdn.io/lib/ace/1.4.12/ext-language_tools.min.js"></script>
    <script type="text/javascript">
      // Load Ace editor and set options
      var editor = ace.edit("editor");
      if (document.getElementById("enable-autocomplete").checked) {
        editor.setOptions({
          enableBasicAutocompletion: true,
          enableSnippets: true,
          enableLiveAutocompletion: true,
        });
      }

      editor.setShowPrintMargin(false);
      editor.setTheme(
        document.getElementById("color-scheme-select").selectedOptions[0].value
      );
      editor.session.setMode("ace/mode/javascript");
      editor.setKeyboardHandler(
        document.getElementById("keybindings-select").selectedOptions[0].value
      );

      document
        .getElementById("keybindings-select")
        .addEventListener("change", (e) => {
          editor.setKeyboardHandler(e.target.selectedOptions[0].value);
        });
      document
        .getElementById("color-scheme-select")
        .addEventListener("change", (e) => {
          /* Clear any styling that's been set on editor (e.g. setting background color to monokai by default) */
          document.getElementById("editor").style = "";
          editor.setTheme(e.target.selectedOptions[0].value);
        });
      document
        .getElementById("enable-autocomplete")
        .addEventListener("change", (e) => {
          const do_auto = document.getElementById("enable-autocomplete")
            .checked;
          editor.setOptions({
            enableBasicAutocompletion: do_auto,
            enableSnippets: do_auto,
            enableLiveAutocompletion: do_auto,
          });
        });

      //==============================
      //      Cookie Stuff
      //==============================
      function setCookie(cname, cvalue, exdays) {
        const d = new Date();
        d.setTime(d.getTime() + exdays * 24 * 60 * 60 * 1000);
        const expires = "expires=" + d.toUTCString();
        const cookieString =
          cname +
          "=" +
          encodeURIComponent(cvalue) +
          ";" +
          expires +
          ";path=/;SameSite=Strict";
        document.cookie = cookieString;
      }

      function saveCodeToCookie(auto = true) {
        document.getElementById("saving-notification").style.opacity = 1;
        const code = editor.getSession().getValue();
        setCookie("vertexFunctionCode", code, 10);

        // Leave notification for a second and then remove
        setTimeout(() => {
          document.getElementById("saving-notification").style.opacity = 0;
        }, 1000);
      }

      setInterval(() => {
        saveCodeToCookie();
      }, 60000);

      function getCookie(cname) {
        const name = cname + "=";
        const ca = document.cookie.split(";");
        for (let i = 0; i < ca.length; i++) {
          let c = ca[i];
          while (c.charAt(0) == " ") {
            c = c.substring(1);
          }
          if (c.indexOf(name) == 0) {
            return decodeURIComponent(c.substring(name.length, c.length));
          }
        }
        return "";
      }

      editor.commands.addCommand({
        name: "saveFile",
        bindKey: {
          win: "Ctrl-S",
          mac: "Command-S",
          sender: "editor|cli",
        },
        exec: function (env, args, request) {
          saveCodeToCookie();
        },
      });

      const code = getCookie("vertexFunctionCode");
      if (code != "") {
        editor.getSession().setValue(code);
      }

      //==============================
      //      Grab User's Code
      //==============================
      // Helper to grab the definition of vertexFunction()
      // We can't do this inside js/demo.js since that's a module, which is in "strict mode"
      // In strict mode, eval gets its own context, and you can't access variabled defined
      // in the string from outside that context
      function extractVertexFunction() {
        const fnString = editor.getSession().getValue();
        eval(fnString);
        return vertexFunction;
      }

      //==============================
      //      Set up mocha (testing framework)
     //==============================
    </script>
    <script src="./js/geometry-processing-js/build/geometry-processing.min.js"></script>
    <script type="module" src="js/demo.js"></script>
  </body>
</html>
